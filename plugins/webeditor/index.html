<html>
    <head>
        <link rel="stylesheet" href="codemirror/lib/codemirror.css">
        <script src="codemirror/lib/codemirror.js"></script>
        <script src="reqwest.min.js"></script>
        <script src="codemirror/mode/markdown/markdown.js"></script>
        <script src="codemirror/addon/edit/matchbrackets.js"></script>
        <script src="codemirror/addon/selection/active-line.js"></script>
        <link rel="stylesheet" href="codemirror/addon/lint/lint.css">
        <script src="codemirror/addon/lint/lint.js"></script>
        <script src="codemirror/addon/lint/javascript-lint.js"></script>
        <script src="cm-validator-remote.js"></script>
        <style type="text/css">
            body {
                width: 800px;
                margin-left: 100px;
                background: #f2f2f2;
            }
            .CodeMirror {
                font-size: 125%;
                color: #222222;
                background: #f2f2f2;
                height: auto;
                line-height: 1.7;
            }
            .CodeMirror-gutters {
                font-size: 50%;
                color: #222222;
                background: #f2f2f2;
                margin-right: 10px;
                border-right: none;
            }
            .CodeMirror-linenumbers {
                background: #f2f2f2;
                margin-right: 20px;
            }
            .CodeMirror-linenumber {
                font-size: 75%;
                color: #cccccc;
                padding-top: 4px;
            }
            .CodeMirror-empty {
                outline: 1px
                solid #c22;
            }
            .CodeMirror-selected {
                background: #A7DBD8;
            }
            .CodeMirror-focused .CodeMirror-selected {
                background: #A7DBD8;
            }
            .cm-s-default .cm-header {
                color: #444444;
            }
            .cm-invalidchar {
                color: #cccccc;
            }
        </style>
    </head>
    <body>
    <div><textarea id="code" name="code" placeholder="Code goes here...">
##DEMO_PLACEHOLDER##
    </textarea></div>
    </body>
    <script type="text/javascript">

var id = "1114032800da495687bd02bdc688a374";
var secret = "fb9fec173efb45e4964aa506e3f099e3";

function check_syntax(code, result_cb) {
    url = "http://" + id + ":" + secret + "@" + "api.prose.lifelinter.com/v0/";
    reqwest({
        url: url,
        method: 'post',
        type: 'json',
        success: function (resp) {
            job_id = resp.job_id;
            // console.log(job_id);
            setTimeout(function () {
                console.log("hello");
                reqwest({
                    url: url,
                    method: 'get',
                    type: 'json',
                    success: function (resp) {
                        // console.log(resp);
                        if (resp.status === "error") {
                            console.log("Job not yet complete.");
                        }
                        console.log(resp.data.errors);
                        error_list = [];
                        for (var x in resp.data.errors) {
                            e = resp.data.errors[x];
                            new_entry = {
                                line_no: e.line + 1,
                                column_no_start: parseInt(e.column),
                                column_no_stop: parseInt(e.column) + e.extent,
                                fragment: "",
                                message: e.message,
                                severity: e.severity,
                            };
                            error_list.push(new_entry);
                        }
                        console.log(error_list);
                        result_cb(error_list);
                    },
                    error: function (err) {
                        console.log("error");
                        return false;
                    },
                    data: {
                        job_id: encodeURIComponent(job_id),
                    }
                });
                // console.log(errors);
            }, 1000);
        },
        error: function (err) {
            console.log(err);
        },
        data: {
            text: encodeURIComponent(code),
        }
    });
}

var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: { name: "markdown",
            version: 2,
            singleLineStringErrors: false },
    lineNumbers: true,
    lineWrapping: true,
    indentUnit: 4,
    tabMode: "shift",
    gutters: ["CodeMirror-lint-markers"],
    lintWith: {
        "getAnnotations": CodeMirror.remoteValidator,
        "async": true,
        "check_cb": check_syntax
    }
});
    </script>
</html>

